# README

The Pipeline stack project has been created to organize our Continuous Integration and Deployment (CI/CD) pipeline. This stack is composed of GitLab, Jenkins, Nexus and the Application.

Some specification on the stack:

_**Gitlab** is a fully integrated software development platform that enables you and your team to work cohesively, faster, transparently, and effectively, since the discussion of a new idea until taking that idea to production all the way through, from within the same platform._
Reference: [Gitlab Overview](https://docs.gitlab.com/ee/user/index.html#overview)

_**Jenkins** is a self-contained, open source automation server which can be used to automate all sorts of tasks related to building, testing, and delivering or deploying software. Jenkins is a highly extensible product whose functionality can be extended through the installation of plugins._
Reference: [Jenkins](https://jenkins.io/doc/)

_**Nexus** The Nexus platform is all about working with components and repositories. A component is a resource like a library or a framework that is used as part of your software application at run-time, integration or unit test execution time, or required as part of your build process. It could be an entire application or a static resource like an image._
Reference: [Nexus](https://help.sonatype.com/repomanager3/repository-manager-concepts/components%2C-repositories%2C-and-repository-formats)

_**Application** The application server is the final result of our Pipeline processing. It contains Java JRE, Scripts to pull and deploy the application from Nexus. Finally, all we need to make the application running on his own._

## High level diagrams

Overview of the current Networking Installation on my local machine
![CurrentLocalInstallation](./resources/presentation/architecture/network/CurrentLocalInstallation.png)

Simulation of Redhat 7 Virual Machine with VirtualBox Centos 7 guest:
![VirtualBox-Guest](./resources/presentation/architecture/vm/VirtualBox-Centos_7.png)

Virtual Machine network type:
![VirtualBox-Network-Type](./resources/presentation/architecture/vm/VirtualBoxNetworkTables.png)

Uses containers instead of multiple virtual machines:
![Docker-Containers](./resources/presentation/architecture/stack/Docker/AWS-Docker-Explanation.png)

## This repository

**ghandalf-pipeline**: 

**stack**: Where the containers are built and deploy.

[Nexus](config/nexus/README.md)

### Set up Git for ghandalf-pipeline

In a terminal, move under the ghandalf-pipeline directory.

- Step 1.
Create the project in GitLab by cliking new project button on the right of the screen.

![Create New Project](./resources/presentation/architecture/stack/Docker/gitlab/CreateNewProject.png)

- Step 1.

  - Then we need to initialize git
    ```bash
    git init
    # Nest two lines, done for each project in case we want to access multiple git repositories
    git config --local user.name fouellet
    git config --local user.password fouellet@dminc.com
    # This is unprotected url will change later, I will provide the new instruction in here.
    git remote add origin http://devops.ghandalf.com:32180/fouellet/ghandalf-pipeline.git
    // Make sure to have a .gitignore file under the project to avoid .svn file in git
    // This command will output a lot of warning about line feed LF, we will resolve it later.
    git add .
    git commit -m "Instantiate Git repository to prepare the migration from SVN"
    git push -u origin master

    You are done, but I like to work on my own branches then merge. 
    git checkout -b develop // Will create a new branch develop
    git add .
    git push --set-upstream origin develop
    git push

    VSCode or Eclipse will swith automatically without any intervention.
    ```

### Networking

Here are how the links between all those networks are done.

_**Host machine**_ (our laptop)
```bash
Under C:\Windows\System32\drivers\etc\hosts add this line:
192.168.56.101 devops devops.ghandalf.com 
// This is how we communicate true VM and expose port in Docker Container
```

_**Virtual Machine**_ - Virtual Box Guest<br>
/etc/hosts:
```bash
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
# Access Rackspace VPN
192.237.229.122 vpn.rackspace.com
# Once connected to Racksapce VPN, use those DNS names to navigate
172.21.0.35 tools.rackspace.com
172.21.0.45 dev.rackspace.com
```
/etc/resolv.conf
```bash
# Generated by NetworkManager
search PS.M4.local ghandalf.com
nameserver 172.22.174.10
nameserver 10.8.0.190
nameserver 10.8.0.203
```
_**PS.M4.local**_ is defined as a DNS server: Pinging PS.M4.local [10.8.0.203]<br>
_**ghandalf.com**_ is defined as a DNS server: Pinging ghandalf.com [162.242.191.60].<br> 
I am not connected with VPN to ghandalf network the address is not in the list.<br>

_**GitLab, Jenkins, Nexus containers**_<br>
/etc/hosts
```bash
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
# In gitlab only
172.20.0.2      gitlab.ghandalf.com gitlab
# In jenkins only
172.20.0.4      jenkins.ghandalf.com jenkins
# In nexus only
172.20.0.3      nexus.ghandalf.com nexus
```
/etc/resolv.conf
```bash
search PS.M4.local ghandalf.com
nameserver 127.0.0.11
options ndots:0
```
Hostname define in docker-compose.yml
```bash
hostname: gitlab.ghandalf.com
hostname: jenkins.ghandalf.com
hostname: nexus.ghandalf.com
```

### Set up

We assume that you have already installed Docker on your local machine:
 [docker, docker-compose]. If not I suggest that you read our master [README](../README.md) file. Be aware that we use the latest versions of Docker.

Once you had installed docker, on Windows, MAC, and Linux you could use the script [service.sh](./service.sh). On Windows, you will need to install [Git Bash](https://gitforwindows.org/), followed their instructions.


Quick overview:

```bash
1. In a terminal, move under the cfan-pipeline/stack project, that you have cloned from SVN repository.
2. Make sure that service.sh file is executable: 
   * > chmod 750 service.sh | chmod +x docker.sh
3. You can use the script to pull images needed for the project. 
   * > ./service.sh pull # Will pull the images we need.
4. Or you can start the stack. It will pull the images automatically.
   * > ./service.sh start stack // it run on the current terminal to see the logs.
   * > ./service.sh stop stack  // you need another terminal to execute it. It does a gracefull shutdown.
```

Some usefuls commands

```bash

1. /service.sh info, Give you information of the swarm, including networking configuration.
2. /service.sh status, Will give you the state of each container.
```

### Reminder ###

The volumes are under /var/lib/docker. This directory needs to be backup. Because we use COMPOSE_PROJECT_NAME in .env and network ['pipeline_net'] the volume 
directory name will be something like: pipelinestack_jenkins-data and pipelinestack-nexus-data
Please be aware if you use docker volume prune and you answer yes, all volumes will be earased. So, no more configuration or data.

### Contribution guidelines

- Code review: done my collegue, and also by given demos.

### Technical advice

- Use https://cloud.google.com/knative/ a nice to have.

### Resources

- Repo owner: Francis Ouellet <fouellet@dminc.com>
- Community: Ghandalf team
